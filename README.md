# osp-cve-scanner
An Ansible role and playbook to perform CVE scans on undercloud and overcloud nodes, and on the downloaded container images.

## Prerequisites
Both undercloud and overcloud are deployed and reachable from the Ansible host.

## Running OpenSCAP scans on the hosts
1. Clone the repository on the ansible host. Using the undercloud for simplicity:
```

```

2. Run provided playbook:
```
[stack@director.example.lab ~]$ ansible-playbook -i /home/stack/overcloud-deploy/overcloud/tripleo-ansible-inventory.yaml osp-cve-scanner/scan-osp-cloud.yaml

PLAY [This playbook runs OpenSCAP verification in RHOSP nodes, then consolidates html reports in a single location] ******************************************************

TASK [cve_scan : Gather facts subset] ************************************************************************************************************************************
ok: [undercloud]

TASK [cve_scan : Install openscap and related utilities] *****************************************************************************************************************
ok: [undercloud]
ok: [overcloud-novacompute-0]
ok: [overcloud-controller-0]

TASK [cve_scan : Set fact with temporary report directory] ***************************************************************************************************************
ok: [undercloud -> localhost]

TASK [cve_scan : Create temporary report directory: /tmp/oscap_report_20240202T180038] ***********************************************************************************
changed: [undercloud]
changed: [overcloud-novacompute-0]
changed: [overcloud-controller-0]

TASK [cve_scan : Create hosts directory structure] ***********************************************************************************************************************
changed: [undercloud]
changed: [overcloud-novacompute-0]
changed: [overcloud-controller-0]

TASK [cve_scan : Download definition files] ******************************************************************************************************************************
changed: [undercloud -> localhost] => (item=/tmp/rhel-9.2-eus.oval.xml.bz2)
changed: [undercloud -> localhost] => (item=/tmp/openstack-17.1.oval.xml.bz2)
changed: [undercloud -> localhost] => (item=/tmp/fast-datapath.oval.xml.bz2)

TASK [cve_scan : Extract oval files] *************************************************************************************************************************************
changed: [undercloud -> localhost] => (item=/tmp/rhel-9.2-eus.oval.xml.bz2)
changed: [undercloud -> localhost] => (item=/tmp/openstack-17.1.oval.xml.bz2)
changed: [undercloud -> localhost] => (item=/tmp/fast-datapath.oval.xml.bz2)

TASK [cve_scan : Copy oval file to target servers] ***********************************************************************************************************************
changed: [undercloud] => (item=/tmp/oscap_report_20240202T180038/rhel-9.2-eus.oval.xml)
changed: [overcloud-novacompute-0] => (item=/tmp/oscap_report_20240202T180038/rhel-9.2-eus.oval.xml)
changed: [undercloud] => (item=/tmp/oscap_report_20240202T180038/openstack-17.1.oval.xml)
changed: [overcloud-controller-0] => (item=/tmp/oscap_report_20240202T180038/rhel-9.2-eus.oval.xml)
changed: [undercloud] => (item=/tmp/oscap_report_20240202T180038/fast-datapath.oval.xml)
changed: [overcloud-novacompute-0] => (item=/tmp/oscap_report_20240202T180038/openstack-17.1.oval.xml)
changed: [overcloud-controller-0] => (item=/tmp/oscap_report_20240202T180038/openstack-17.1.oval.xml)
changed: [overcloud-novacompute-0] => (item=/tmp/oscap_report_20240202T180038/fast-datapath.oval.xml)
changed: [overcloud-controller-0] => (item=/tmp/oscap_report_20240202T180038/fast-datapath.oval.xml)

TASK [cve_scan : Remove definition files from ansible host] **************************************************************************************************************
changed: [undercloud -> localhost] => (item=/tmp/rhel-9.2-eus.oval.xml)
changed: [undercloud -> localhost] => (item=/tmp/openstack-17.1.oval.xml)
changed: [undercloud -> localhost] => (item=/tmp/fast-datapath.oval.xml)

TASK [cve_scan : Perform OpenSCAP scans of host OS] **********************************************************************************************************************
changed: [overcloud-novacompute-0] => (item=rhel-9.2-eus.oval.xml)
changed: [undercloud] => (item=rhel-9.2-eus.oval.xml)
changed: [overcloud-controller-0] => (item=rhel-9.2-eus.oval.xml)
changed: [overcloud-novacompute-0] => (item=openstack-17.1.oval.xml)
changed: [undercloud] => (item=openstack-17.1.oval.xml)
changed: [undercloud] => (item=fast-datapath.oval.xml)
changed: [overcloud-controller-0] => (item=openstack-17.1.oval.xml)
changed: [overcloud-novacompute-0] => (item=fast-datapath.oval.xml)
changed: [overcloud-controller-0] => (item=fast-datapath.oval.xml)

TASK [cve_scan : List container images] **********************************************************************************************************************************
skipping: [undercloud]
skipping: [overcloud-controller-0]
skipping: [overcloud-novacompute-0]

TASK [cve_scan : Inspect images] *****************************************************************************************************************************************
skipping: [undercloud]
skipping: [overcloud-controller-0]
skipping: [overcloud-novacompute-0]

TASK [cve_scan : Scan container images] **********************************************************************************************************************************
skipping: [undercloud]
skipping: [overcloud-controller-0]
skipping: [overcloud-novacompute-0]

TASK [cve_scan : List files in target host] ******************************************************************************************************************************
changed: [undercloud]
changed: [overcloud-novacompute-0]
changed: [overcloud-controller-0]

TASK [cve_scan : Copy target files to ansible host] **********************************************************************************************************************
ok: [undercloud] => (item=/tmp/oscap_report_20240202T180038/undercloud/rhel-9.2-eus.oval.xml.html)
ok: [undercloud] => (item=/tmp/oscap_report_20240202T180038/undercloud/openstack-17.1.oval.xml.html)
changed: [overcloud-novacompute-0] => (item=/tmp/oscap_report_20240202T180038/overcloud-novacompute-0/rhel-9.2-eus.oval.xml.html)
changed: [overcloud-controller-0] => (item=/tmp/oscap_report_20240202T180038/overcloud-controller-0/rhel-9.2-eus.oval.xml.html)
ok: [undercloud] => (item=/tmp/oscap_report_20240202T180038/undercloud/fast-datapath.oval.xml.html)
changed: [overcloud-novacompute-0] => (item=/tmp/oscap_report_20240202T180038/overcloud-novacompute-0/openstack-17.1.oval.xml.html)
changed: [overcloud-controller-0] => (item=/tmp/oscap_report_20240202T180038/overcloud-controller-0/openstack-17.1.oval.xml.html)
changed: [overcloud-novacompute-0] => (item=/tmp/oscap_report_20240202T180038/overcloud-novacompute-0/fast-datapath.oval.xml.html)
changed: [overcloud-controller-0] => (item=/tmp/oscap_report_20240202T180038/overcloud-controller-0/fast-datapath.oval.xml.html)

TASK [cve_scan : Create report archive] **********************************************************************************************************************************
changed: [undercloud -> localhost]

TASK [cve_scan : Report path to archive] *********************************************************************************************************************************
ok: [undercloud -> localhost] => {
    "msg": "/tmp/oscap_report_20240202T180038.tgz"
}

TASK [cve_scan : Copy report files to target] ****************************************************************************************************************************
skipping: [undercloud]

TASK [cve_scan : Copy report tarball to target] **************************************************************************************************************************
skipping: [undercloud]

TASK [cve_scan : Cleanup hosts] ******************************************************************************************************************************************
changed: [undercloud]
changed: [overcloud-novacompute-0]
changed: [overcloud-controller-0]

TASK [cve_scan : Cleanup ansible host] ***********************************************************************************************************************************
skipping: [undercloud]

PLAY RECAP ***************************************************************************************************************************************************************
overcloud-controller-0     : ok=8    changed=7    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   
overcloud-novacompute-0    : ok=8    changed=7    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   
undercloud                 : ok=15   changed=10   unreachable=0    failed=0    skipped=6    rescued=0    ignored=0   

[stack@director.example.lab ~]$ 
```

3. Copy tar file to desired location and examine the html reports inside
